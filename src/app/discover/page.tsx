\'use client\';\n\nimport { useEffect, useState, useMemo } from \'react\';\nimport { useRouter } from \'next/navigation\';\nimport { Button } from \'@/components/ui/button\';\nimport { Checkbox } from \'@/components/ui/checkbox\';\nimport { Label } from \'@/components/ui/label\';\nimport { Separator } from \'@/components/ui/separator\';\nimport { cn } from \'@/lib/utils\';\nimport WanderlinkHeader from \'@/components/wanderlink-header\';\nimport { CountrySelect } from \'@/components/country-select\';\nimport { GenericSelect } from \'@/components/generic-select\';\nimport { ToggleGroup, ToggleGroupItem } from \'@/components/ui/toggle-group\';\nimport { DateRangePicker } from \'@/components/ui/date-range-picker\';\nimport { AgeRangeSlider } from \'@/components/ui/age-range-slider\';\nimport type { DateRange } from \'react-day-picker\';\nimport { travelIntentions, travelStyles, travelActivities } from \'@/lib/options\';\nimport { onAuthStateChanged, type User } from \'firebase/auth\';\nimport { auth } from \'@/lib/firebase\';\nimport { getUserProfile } from \'@/lib/firebase-actions\';\nimport type { DocumentData } from \'firebase/firestore\';\nimport { Loader2, Search, Crown } from \'lucide-react\';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \'@/components/ui/alert-dialog\';\nimport { getFunctions, httpsCallable } from \'firebase/functions\';\nimport { functions } from \'@/lib/firebase\';\n\nconst getAlgoliaConfig = httpsCallable(functions, \'getAlgoliaConfig\');\n\nexport default function DiscoverPage() {\n    const router = useRouter();\n    const [currentUser, setCurrentUser] = useState<User | null>(null);\n    const [userProfile, setUserProfile] = useState<DocumentData | null>(null);\n    const [loading, setLoading] = useState(true);\n    const [isPremiumDialogOpen, setIsPremiumDialogOpen] = useState(false);\n    const [isSearching, setIsSearching] = useState(false);\n    const [algoliaClient, setAlgoliaClient] = useState<any>(null);\n\n    const usersIndex = useMemo(() => {\n        if (algoliaClient) {\n            return algoliaClient.initIndex(\"users\");\n        }\n        return null;\n    }, [algoliaClient]);\n\n    const [showMe, setShowMe] = useState(\'Femme\');\n    const [ageRange, setAgeRange] = useState<[number, number]>([25, 45]);\n    const [date, setDate] = useState<DateRange | undefined>();\n    const [flexibleDates, setFlexibleDates] = useState(true);\n    const [nearby, setNearby] = useState(true);\n    const [country, setCountry] = useState(\'\');\n    const [destination, setDestination] = useState(\'Toutes\');\n    const [intention, setIntention] = useState(\'\');\n    const [travelStyle, setTravelStyle] = useState(\'Tous\');\n    const [activities, setActivities] = useState(\'Toutes\');\n\n    useEffect(() => {\n        const unsubscribe = onAuthStateChanged(auth, (user) => {\n            setCurrentUser(user);\n            if (user) {\n                getUserProfile(user.uid).then(profile => {\n                    setUserProfile(profile);\n                    if (profile) {\n                        if (profile.gender === \'Femme\') {\n                            setShowMe(\'Homme\');\n                        } else if (profile.gender === \'Autre\') {\n                            setShowMe(\'Autre\');\n                        } else {\n                            setShowMe(\'Femme\');\n                        }\n                    }\n                });\n\n                const initAlgolia = async () => {\n                    try {\n                        const result = await getAlgoliaConfig();\n                        const config = result.data as { appId: string, searchKey: string };\n\n                        if (config && config.appId && config.searchKey) {\n                            const algoliaModule = await import(\'algoliasearch/lite\');\n                            const algoliaInit = algoliaModule.default || algoliaModule;\n\n                            if (typeof algoliaInit !== \'function\') {\n                                console.error(\"Failed to load Algolia search function.\", algoliaInit);\n                                setLoading(false);\n                                return;\n                            }\n\n                            const client = algoliaInit(config.appId, config.searchKey);\n                            setAlgoliaClient(client);\n                        } else {\n                            console.error(\'Could not initialize Algolia. Invalid config received.\');\n                        }\n                    } catch (error) {\n                        console.error(\"Error initializing Algolia:\", error);\n                    } finally {\n                        setLoading(false);\n                    }\n                };\n\n                initAlgolia();\n\n            } else {\n                setLoading(false);\n                router.push(\'/login\');\n            }\n        });\n        return () => unsubscribe();\n    }, [router]);\n\n    const handleNearbyChange = (checked: boolean) => {\n        if (!userProfile?.isPremium && !checked) {\n            setIsPremiumDialogOpen(true);\n            return;\n        }\n        setNearby(checked);\n        if (checked) {\n            setCountry(\'\');\n        }\n    };\n\n    const handleFlexibleDatesChange = (checked: boolean) => {\n        setFlexibleDates(checked);\n        if (checked) {\n            setDate(undefined);\n        }\n    };\n\n    const handleSearch = async () => {\n        if (!usersIndex || !userProfile || !currentUser) return;\n        setIsSearching(true);\n    \n        const filters = [];\n        if (showMe) filters.push(`gender:${showMe}`);\n        \n        const numericFilters = [];\n        numericFilters.push(`age >= ${ageRange[0]}`);\n        numericFilters.push(`age <= ${ageRange[1]}`);\n    \n        if (country && !nearby && userProfile.isPremium) filters.push(`location:\\\"${country}\\\"\`);\n        if (destination && destination !== \'Toutes\') filters.push(`destination:\\\"${destination}\\\"\`);\n        if (intention && userProfile.isPremium) filters.push(`intention:\\\"${intention}\\\"\`);\n        if (travelStyle && travelStyle !== \'Tous\' && userProfile.isPremium) filters.push(`travelStyle:\\\"${travelStyle}\\\"\`);\n        if (activities && activities !== \'Toutes\' && userProfile.isPremium) filters.push(`activities:\\\"${activities}\\\"\`);\n    \n        filters.push(`NOT objectID:${currentUser.uid}`);\n    \n        const searchOptions: any = {\n            filters: filters.join(\' AND \'),\n            numericFilters: numericFilters.join(\' AND \'),\n        };\n    \n        if (nearby && userProfile.latitude && userProfile.longitude) {\n            searchOptions.aroundLatLng = `${userProfile.latitude}, ${userProfile.longitude}`;\n            searchOptions.aroundRadius = 50000; // 50km\n        }\n    \n        try {\n            const { hits } = await usersIndex.search(\'\', searchOptions);\n            const searchResults = hits.map((hit: any) => ({ ...hit, _highlightResult: undefined, _snippetResult: undefined, objectID: undefined }));\n            localStorage.setItem(\'searchResults\', JSON.stringify(searchResults));\n            router.push(\'/\');\n        } catch (error) {\n            console.error(\"Error searching with Algolia:\", error);\n        } finally {\n            setIsSearching(false);\n        }\n    };\n    \n    const handlePremiumFeatureClick = () => {\n        if (!userProfile?.isPremium) {\n            setIsPremiumDialogOpen(true);\n        }\n    };\n\n    const uniformSelectClass = \"w-3/5 md:w-[45%] h-9 text-sm\";\n    const isPremium = userProfile?.isPremium ?? false;\n\n    if (loading) {\n         return (\n            <div className=\"flex h-screen w-full flex-col items-center justify-center bg-background\">\n                <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"min-h-screen bg-background text-foreground\">\n            <WanderlinkHeader />\n            <main className=\"pt-12 pb-24\">\n                <div className=\"container mx-auto max-w-4xl px-4\">\n                    <div className=\"space-y-2 mb-4\">\n                      <h2 className=\"font-semibold text-sm\">Montre-moi</h2>\n                      <div className=\"flex justify-center\">\n                        <ToggleGroup\n                          type=\"single\"\n                          value={showMe}\n                          onValueChange={(value) => { if (value) setShowMe(value) }}\n                          className=\"w-auto justify-start bg-slate-100 dark:bg-slate-800 p-1 rounded-full\"\n                        >\n                          <ToggleGroupItem value=\"Homme\" aria-label=\"Montrer les hommes\" className=\"text-sm h-9\">Homme</ToggleGroupItem>\n                          <ToggleGroupItem value=\"Femme\" aria-label=\"Montrer les femmes\" className=\"text-sm h-9\">Femme</ToggleGroupItem>\n                          <ToggleGroupItem value=\"Autre\" aria-label=\"Montrer les autres\" className=\"text-sm h-9\">Autre</ToggleGroupItem>\n                        </ToggleGroup>\n                      </div>\n                    </div>\n                \n                    <div className=\"space-y-4\">\n                        <div className=\"rounded-lg border bg-card p-3\">\n                            <AgeRangeSlider value={ageRange} onValueChange={setAgeRange} />\n                        </div>\n\n                        <div className=\"space-y-1\">\n                            <h2 className=\"font-semibold text-sm\">Position</h2>\n                            <div className=\"rounded-lg border bg-card p-2 space-y-2\">\n                                <div className=\"flex items-center justify-between py-1 px-1\">\n                                    <Label htmlFor=\"nearby\" className=\"text-sm font-normal\">Personnes à proximité</Label>\n                                    <Checkbox id=\"nearby\" checked={nearby} onCheckedChange={handleNearbyChange} />\n                                </div>\n                                <Separator />\n                                <div onClick={!isPremium && !nearby ? handlePremiumFeatureClick : undefined} className={cn(!isPremium && !nearby && \'cursor-pointer\')}>\n                                    <div className=\"flex items-center justify-between py-1 px-1 text-sm\">\n                                        <div className=\"flex items-center gap-2\">\n                                            <span className={cn(\'text-muted-foreground\', (nearby || !isPremium) && \'opacity-50\')}>Pays</span>\n                                            {!isPremium && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                                        </div>\n                                        <CountrySelect className={uniformSelectClass} value={country} onValueChange={setCountry} disabled={nearby || !isPremium} />\n                                    </div>\n                                </div>\n                                <Separator />\n                                <div className=\"flex items-center justify-between py-1 px-1 text-sm\">\n                                    <span className=\"text-muted-foreground\">Destination</span>\n                                    <CountrySelect className={uniformSelectClass} value={destination} onValueChange={setDestination} placeholder=\"Toutes\" />\n                                </div>\n                            </div>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                          <h2 className=\"font-semibold text-sm\">Dates de voyage</h2>\n                            <div className=\"rounded-lg border bg-card p-3 space-y-3\">\n                                <DateRangePicker date={date} onDateChange={setDate} disabled={flexibleDates} />\n                                <div className=\"flex items-center space-x-2\">\n                                    <Checkbox id=\"flexible-dates\" checked={flexibleDates} onCheckedChange={handleFlexibleDatesChange} />\n                                    <Label htmlFor=\"flexible-dates\" className=\"text-sm\">Mes dates sont flexibles</Label>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div className=\"space-y-1\">\n                            <h2 className=\"font-semibold text-sm\">Filtres Avancés</h2>\n                            <div className=\"rounded-lg border bg-card p-2 space-y-2\">\n                                <div onClick={!isPremium ? handlePremiumFeatureClick : undefined} className={cn(!isPremium && \'cursor-pointer\')}>\n                                    <div className=\"flex items-center justify-between py-1 px-1 text-sm\">\n                                        <div className=\"flex items-center gap-2\">\n                                            <span className={cn(\'text-muted-foreground\', !isPremium && \'opacity-50\')}>Intention</span>\n                                            {!isPremium && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                                        </div>\n                                        <GenericSelect className={uniformSelectClass} value={intention} onValueChange={setIntention} options={[{ value: \'\', label: \'Toutes\' }, ...travelIntentions]} placeholder=\"Toutes\" disabled={!isPremium} />\n                                    </div>\n                                </div>\n                                <Separator />\n                                <div onClick={!isPremium ? handlePremiumFeatureClick : undefined} className={cn(!isPremium && \'cursor-pointer\')}>\n                                    <div className=\"flex items-center justify-between py-1 px-1 text-sm\">\n                                        <div className=\"flex items-center gap-2\">\n                                            <span className={cn(\'text-muted-foreground\', !isPremium && \'opacity-50\')}>Style de voyage</span>\n                                            {!isPremium && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                                        </div>\n                                        <GenericSelect className={uniformSelectClass} value={travelStyle} onValueChange={setTravelStyle} options={travelStyles} placeholder=\"Tous\" disabled={!isPremium} />\n                                    </div>\n                                </div>\n                                <Separator />\n                                <div onClick={!isPremium ? handlePremiumFeatureClick : undefined} className={cn(!isPremium && \'cursor-pointer\')}>\n                                    <div className=\"flex items-center justify-between py-1 px-1 text-sm\">\n                                        <div className=\"flex items-center gap-2\">\n                                            <span className={cn(\'text-muted-foreground\', !isPremium && \'opacity-50\')}>Activités</span>\n                                            {!isPremium && <Crown className=\"h-4 w-4 text-yellow-500\" />}\n                                        </div>\n                                        <GenericSelect className={uniformSelectClass} value={activities} onValueChange={setActivities} options={travelActivities} placeholder=\"Toutes\" disabled={!isPremium} />\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </main>\n            <footer className=\"fixed bottom-0 z-10 w-full p-2 bg-background/80 backdrop-blur-sm border-t\">\n                <Button onClick={handleSearch} size=\"lg\" className=\"w-full\" disabled={isSearching || !algoliaClient}>\n                    {isSearching ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Search className=\"mr-2 h-4 w-4\" />}\n                    {isSearching ? \'Recherche...\' : \'Recherche\'}\n                </Button>\n            </footer>\n\n            <AlertDialog open={isPremiumDialogOpen} onOpenChange={setIsPremiumDialogOpen}>\n                <AlertDialogContent>\n                    <AlertDialogHeader>\n                        <AlertDialogTitle className=\"flex items-center gap-2\">\n                            <Crown className=\"text-yellow-500\" />\n                            Fonctionnalité WanderLink Gold\n                        </AlertDialogTitle>\n                        <AlertDialogDescription>\n                            Passez à Gold pour débloquer le Mode Passeport et les filtres avancés.\n                        </AlertDialogDescription>\n                    </AlertDialogHeader>\n                    <AlertDialogFooter>\n                        <AlertDialogCancel>Plus tard</AlertDialogCancel>\n                        <AlertDialogAction onClick={() => router.push(\'/premium\')}>\n                            Passer à Gold\n                        </AlertDialogAction>\n                    </AlertDialogFooter>\n                </AlertDialogContent>\n            </AlertDialog>\n        </div>\n    );\n}\n